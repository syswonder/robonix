from uapi.specs.skill_specs import EntityPath
from uapi.runtime.flow import flow, EOS_TYPE_FlowResult, get_runtime, flow_print


# @flow
# def move_a_to_b(a: EntityPath, b: EntityPath) -> EOS_TYPE_FlowResult:
#     runtime = get_runtime()
#     A = runtime.get_graph().get_entity_by_path(a)
#     B = runtime.get_graph().get_entity_by_path(b)
#     if A is None:
#         flow_print(f"entity A not found at path: {a}")
#         return EOS_TYPE_FlowResult.FAILURE
#     if B is None:
#         flow_print(f"entity B not found at path: {b}")
#         return EOS_TYPE_FlowResult.FAILURE
#     b_pos = B.c_space_getpos()
#     flow_print(f"entity B position: {b_pos}")
#     result = A.c_space_move(x=b_pos["x"], y=b_pos["y"], z=b_pos["z"])
#     flow_print(f"move result: {result}")
#     if not result["success"]:
#         flow_print(f"move failed: {result}")
#         return EOS_TYPE_FlowResult.FAILURE
#     return EOS_TYPE_FlowResult.SUCCESS


@flow
def move_and_capture_flow(a: EntityPath, b: EntityPath) -> EOS_TYPE_FlowResult:
    runtime = get_runtime()
    A = runtime.get_graph().get_entity_by_path(a)
    B = runtime.get_graph().get_entity_by_path(b)

    if A is None:
        flow_print(f"entity A not found at path: {a}")
        return EOS_TYPE_FlowResult.FAILURE
    if B is None:
        flow_print(f"entity B not found at path: {b}")
        return EOS_TYPE_FlowResult.FAILURE

    # Get robot pose before movement
    flow_print("getting initial robot pose...")
    initial_pose = A.c_space_getpos()
    if initial_pose is None:
        flow_print("failed to get initial robot pose")
        return EOS_TYPE_FlowResult.FAILURE
    flow_print(f"initial pose: {initial_pose}")

    # Capture initial images
    flow_print("capturing initial images...")
    A.c_save_rgb_image(
        filename="./simulator/examples/simple_demo_1/initial_rgb.jpg",
        camera_name="robot_camera",
        width=640,
        height=480,
    )
    A.c_save_depth_image(
        filename="./simulator/examples/simple_demo_1/initial_depth.npy",
        camera_name="robot_camera",
        width=640,
        height=480,
    )

    # Move to target
    b_pos = B.c_space_getpos()
    flow_print(f"moving to position: {b_pos}")
    result = A.c_space_move(x=b_pos["x"], y=b_pos["y"], z=b_pos["z"])
    if not result["success"]:
        flow_print(f"move failed: {result}")
        return EOS_TYPE_FlowResult.FAILURE

    # Get robot pose after movement
    flow_print("getting final robot pose...")
    final_pose = A.c_space_getpos()
    if final_pose is None:
        flow_print("failed to get final robot pose")
        return EOS_TYPE_FlowResult.FAILURE
    flow_print(f"final pose: {final_pose}")

    # Capture final images
    flow_print("capturing final images...")
    A.c_save_rgb_image(
        filename="./simulator/examples/simple_demo_1/final_rgb.jpg",
        camera_name="robot_camera",
        width=640,
        height=480,
    )
    A.c_save_depth_image(
        filename="./simulator/examples/simple_demo_1/final_depth.npy",
        camera_name="robot_camera",
        width=640,
        height=480,
    )

    flow_print("move and capture flow completed successfully!")
    return EOS_TYPE_FlowResult.SUCCESS
